name: Bootstrap Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to bootstrap (must match a file in infra/environments/)'
        required: true
        type: choice
        options:
          - prod
          - staging
      action:
        description: 'Terraform action to run'
        required: true
        type: choice
        options:
          - plan
          - apply
        default: plan
      auth_method:
        description: 'Authentication method'
        required: true
        type: choice
        options:
          - oidc
          - access_keys
        default: oidc
      first_time_setup:
        description: 'First-time setup? Creates S3 bucket, DynamoDB table, verifies secrets. Skip for existing environments.'
        required: true
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TF_WORKING_DIR: infra

jobs:
  bootstrap:
    name: Bootstrap ${{ inputs.environment }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        if: inputs.auth_method == 'oidc'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS credentials (Access Keys)
        if: inputs.auth_method == 'access_keys'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ---------- Create state backend resources (first-time only) ----------
      - name: Create S3 state bucket
        if: inputs.first_time_setup
        run: |
          BUCKET="showcase-terraform-state-${{ inputs.environment }}"
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket $BUCKET already exists, skipping."
          else
            aws s3api create-bucket --bucket "$BUCKET" --region ${{ env.AWS_REGION }}
            aws s3api put-bucket-versioning \
              --bucket "$BUCKET" \
              --versioning-configuration Status=Enabled
            aws s3api put-public-access-block \
              --bucket "$BUCKET" \
              --public-access-block-configuration \
                BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
            echo "Created and configured bucket: $BUCKET"
          fi

      - name: Create DynamoDB lock table
        if: inputs.first_time_setup
        run: |
          TABLE="showcase-terraform-locks-${{ inputs.environment }}"
          if aws dynamodb describe-table --table-name "$TABLE" 2>/dev/null; then
            echo "Table $TABLE already exists, skipping."
          else
            aws dynamodb create-table \
              --table-name "$TABLE" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region ${{ env.AWS_REGION }}
            echo "Created lock table: $TABLE"
          fi

      # ---------- Verify DB password exists in Secrets Manager (first-time only) ----------
      - name: Verify DB password exists in AWS Secrets Manager
        if: inputs.first_time_setup
        run: |
          SECRET_NAME="showcase/${{ inputs.environment }}/db-password"
          if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" 2>/dev/null; then
            echo "DB password secret found: $SECRET_NAME"
          else
            echo "::error::DB password secret not found in AWS Secrets Manager!"
            echo "::error::Create it first via AWS Console or CLI:"
            echo "::error::  aws secretsmanager create-secret --name $SECRET_NAME --secret-string 'YOUR_PASSWORD' --region ${{ env.AWS_REGION }}"
            exit 1
          fi

      # ---------- Terraform init, plan, apply ----------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.5"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="environments/${{ inputs.environment }}.backend.hcl"

      - name: Terraform Format Check
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Validate
        run: terraform validate -no-color

      - name: Terraform Plan
        run: |
          terraform plan -no-color -input=false \
            -var-file="environments/${{ inputs.environment }}.tfvars"

      - name: Terraform Apply
        if: inputs.action == 'apply'
        run: |
          terraform apply -auto-approve -input=false \
            -var-file="environments/${{ inputs.environment }}.tfvars"

      # ---------- Show outputs after apply ----------
      - name: Show Terraform Outputs
        if: inputs.action == 'apply'
        run: terraform output -no-color
